<!DOCTYPE html>
<html lang="en">
<head>
    <title>Strava Heat Map</title>

    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <link rel="stylesheet"
          href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css"
          integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi"
          crossorigin="anonymous">
    <style>

      #map-canvas {
        background: transparent url(images/spinner.gif) no-repeat center;
      }

      html, body, #map-canvas {
        height: 90%;
        margin: 0;
        padding: 0;
      }

    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&key=AIzaSyAo1VJgamiR5p_knFwA6V0uomIrTXM6xD4"></script>
    <!--<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places"></script>-->
    <script>

var data;
var streams;
var map;
var polygons = [];

function initialize() {
  map = new google.maps.Map(document.getElementById('map-canvas'), {
    zoom: 10,
    center: {lat: 52.20, lng: -2.25}
  });

  var input = document.getElementById('searchTextField');
  var searchBox = new google.maps.places.SearchBox(input);

  google.maps.event.addListener(searchBox, 'places_changed', function() {
    var places = searchBox.getPlaces();
    map.setCenter(places[0].geometry.location);
    map.setZoom(15);
 });

 updatePolygons();
}

function updatePolygons() {
  if(polygons) {
    for (var i=0; i<polygons.length; i++) {
      polygons[i].setMap(null);
    }
  }

  var jqXHR = $.getJSON('/latestActivity', function(json) {
    streams = json;

    for(var i=0; i<streams.length; i++) {
      polygon = new google.maps.Polygon({
        path: streams[i].data,
        strokeColor: '#FF0000',
        strokeOpacity: 1,
        strokeWeight: 2,
        fillColor: '#FF0000',
        fillOpacity: 0.1
      });

      polygon.setMap(map);
      polygons.push(polygon);
    }
  });

  jqXHR.fail(function(jqXHR, textStatus, errorThrown) {
    if (jqXHR.status !== 200) {
      console.log('Could not fetch activities: ' + jqXHR.status + ' ' + textStatus);
      document.location = 'login1.html';
    }
  });
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
</head>

<body>
<h1>Strava Heat Map</h1>

<p>Showing overlaid areas of Strava activity, for the last 10 activities.</p>

<form>
    Find your area:
    <input style="font-family: Roboto" type="text" id="searchTextField" size="50" value="Worcester, United Kingdom"/>
</form>
<p></p>

<div id="map-canvas"></div>

</body>
</html>
